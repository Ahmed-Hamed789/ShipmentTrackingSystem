@model ShipmentTrackingSystem.Models.Shipment
@{
    ViewData["Title"] = $"Track {Model.TrackingNumber}";
    var gKey = (string)ViewBag.GoogleMapsKey!;
}
<div class="row">
    <div class="col-md-4">
        <h4>Tracking: @Model.TrackingNumber</h4>
        <dl class="mt-3">
            <dt>Status</dt>
            <dd id="statusText">@Model.Status</dd>

            <dt>Note</dt>
            <dd id="statusNote">@Model.StatusNote</dd>

            <dt>Driver number for communication :</dt>
            <dd id="driverPhone">@Model.Driver?.Phone</dd>

            <dt>From</dt>
            <dd>@Model.OriginAddress</dd>

            <dt>To</dt>
            <dd>@Model.DestinationAddress</dd>
        </dl>
    </div>
    <div class="col-md-8">
        <div id="map" style="height:480px"></div>
    </div>
</div>

@section Scripts {
    <script src="https://maps.googleapis.com/maps/api/js?key=@gKey&libraries=geometry"></script>
    <script>
        const trackingNumber = "@Model.TrackingNumber";
        const origin = { lat: @Model.OriginLat, lng: @Model.OriginLng };
        const dest   = { lat: @Model.DestLat,   lng: @Model.DestLng   };

        let map, originMarker, destMarker, courierMarker, path;
        function initMap() {
          map = new google.maps.Map(document.getElementById("map"), { center: origin, zoom: 7 });
          originMarker = new google.maps.Marker({ position: origin, map, label: "O" });
          destMarker   = new google.maps.Marker({ position: dest, map, label: "D" });
          path = new google.maps.Polyline({ map, path: [origin, dest] });
          courierMarker = new google.maps.Marker({ map, label: "•" });
        }
        initMap();

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/hubs/tracking")
            .withAutomaticReconnect()
            .build();

        connection.on("TrackingUpdate", (msg) => {
          if (msg.trackingNumber !== trackingNumber) return;

          if (msg.status)     document.getElementById("statusText").innerText  = msg.status;
          if (msg.statusNote) document.getElementById("statusNote").innerText = msg.statusNote;
          if (msg.driverPhone)document.getElementById("driverPhone").innerText= msg.driverPhone;

          if (msg.lat && msg.lng) {
            const p = { lat: msg.lat, lng: msg.lng };
            courierMarker.setPosition(p);
            map.panTo(p);
          }
        });

        connection.start().then(() => connection.invoke("JoinGroup", trackingNumber));
    </script>
}
